-- 文件名　：jiaoyuhuatong.lua
-- 创建者　：furuilei
-- 创建时间：2010-01-13 10:48:49
-- 功能描述：结婚相关npc（自动放结婚技能的教育npc）

Marry.tbJiaoyuHuatong = Marry.tbJiaoyuHuatong or {};
local tbNpc = Marry.tbJiaoyuHuatong;

--===============================================================

tbNpc.CASTSKILL_TIME = 5;	-- 消息停留时间

-- npc的刷出坐标{[npcid] = {{坐标1}, {坐标2}, ...}
tbNpc.tbNpcPos = {
	[6518] = {
{500,1586,3181},
{500,1591,3177},
{500,1597,3173},
{500,1613,3154},
{500,1620,3168},
{500,1601,3164},
{500,1610,3178},
{500,1623,3144},
{500,1634,3156},
{500,1649,3138},
{500,1642,3125},
{500,1652,3115},
{500,1661,3128},
{500,1661,3099},
{500,1677,3119},
{500,1674,3095},
{500,1683,3105},
{500,1660,3084},
{500,1665,3073},
{500,1673,3066},
{500,1696,3063},
{500,1706,3069},
{500,1713,3077},
{500,1717,3096},
{500,1714,3107},
{500,1706,3117},
{500,1697,3123},
{500,1685,3123},
{500,1690,3097},
{500,1702,3096},
{500,1709,3088},
{500,1681,3088},
{500,1681,3076},
{500,1689,3068},
{500,1604,3088},
{500,1595,3099},
{500,1607,3132},
{500,1630,3033},
{500,1643,3046},
{500,1671,3050},
{500,1706,3149},
{500,1720,3137},
{500,1736,3171},
{500,1679,3198},
{500,1673,3148},
{500,1682,3148},
{498,1647,3279},
{498,1638,3304},
{498,1630,3297},
{498,1617,3308},
{498,1625,3318},
{498,1647,3379},
{498,1640,3273},
{498,1634,3245},
{498,1651,3259},
{498,1657,3265},
{498,1669,3240},
{498,1676,3251},
{498,1709,3197},
{498,1718,3207},
{498,1720,3185},
{498,1730,3195},
{498,1754,3053},
{498,1735,3170},
{498,1744,3181},
{498,1746,3159},
{498,1756,3170},
{498,1774,3129},
{498,1783,3138},
{498,1792,3151},
{498,1789,3172},
{498,1777,3158},
{498,1789,3167},
{498,1759,3136},
{498,1761,3124},
{498,1748,3130},
{498,1723,3135},
{498,1738,3090},
{498,1715,3143},
{498,1696,3162},
{498,1728,3217},
{498,1760,3222},
{498,1767,3214},
{498,1806,3227},
{498,1798,3238},
{498,1828,225},
{498,1818,3190},
{498,1832,3183},
{498,1883,3190},
{498,1864,3203},
{498,1843,3233},
{498,1820,3274},
{498,1711,3042},
{498,1802,3264},
{498,1773,3271},
{498,1741,3285},
{498,1721,3311},
{498,1703,3281},
{498,1682,3284},
{498,1657,3218},
{498,1645,3226},
{498,1629,3180},
{498,1654,3156},
{498,1674,3152},
{498,1696,3111},
{498,1651,3114},
{498,1676,3095},
{498,1678,3065},
{498,1705,3070},
{498,1690,3040},
{499,1550,3141},
{499,1529,3155},
{499,1558,3099},
{499,1572,3111},
{499,1586,3090},
{499,1588,3112},
{499,1609,3113},
{499,1623,3043},
{499,1639,3082},
{499,1658,3096},
{499,1676,3055},
{499,1625,3129},
{499,1642,3147},
{499,1662,3168},
{499,1694,3201},
{499,1705,3207},
{499,1683,3231},
{499,1653,3234},
{499,1661,3241},
{499,1635,3237},
{499,1615,3258},
{499,1640,3266},
{499,1640,3282},
{499,1661,3262},
{499,1623,3279},
{499,1595,3129},
{499,1587,3138},
{499,1572,3151},
{499,1573,3172},
{499,1584,3183},
{499,1594,3191},
{499,1625,3202},
{499,1640,3186},
{499,1647,3170},
{499,1597,3160},
{499,1592,3171},
{499,1606,3184},
{499,1617,3178},
{499,1479,3296},
{499,1573,3198},
{499,1581,3205},
{499,1563,3208},
{499,1571,3217},
{499,1551,3220},
{499,1560,3228},
{499,1540,3231},
{499,1548,3239},
{499,1529,3242},
{499,1538,3250},
{499,1519,3253},
{499,1529,3262},
{499,1491,3280},
{499,1502,3290},
{499,1477,3269},
{499,1464,3281},
{499,1632,3259},
{575,1486,3373	},
{575,	1497	,	3385	},
{575,	1501	,	3362	},
{575,	1510	,	3371	},
{575,	1527	,	3301	},
{575,	1551	,	3256	},
{575,	1542	,	3316	},
{575,	1566	,	3220	},
{575,	1559	,	3266	},
{575,	1581	,	3210	},
{575,	1597	,	3227	},
{575,	1595	,	3249	},
{575,	1534	,	3227	},
{575,	1527	,	3237	},
{575,	1545	,	3216	},
{575,	1536	,	3246	},
{575,	1565	,	3194	},
{575,	1555	,	3204	},
{575,	1561	,	3245	},
{575,	1570	,	3254	},
{575,	1571	,	3281	},
{575,	1580	,	3291	},
{575,	1586	,	3195	},
{575,	1589	,	3283	},
{575,	1598	,	3274	},
{575,	1603	,	3233	},
{575,	1605	,	3266	},
{575,	1623	,	3232	},
{575,	1490	,	3253	},
{575,	1499	,	3261	},
{575,	1511	,	3215	},
{575,	1528	,	3179	},
{575,	1520	,	3225	},
{575,	1536	,	3199	},
{575,	1599	,	3339	},
{575,	1606	,	3345	},
{575,	1621	,	3299	},
{575,	1629	,	3307	},
},
	[6520] = {{499, 1536, 3139}, {499, 1479, 3281},
	{498, 1821, 3243}, {498, 1697, 3053},
	{500, 1670, 3107}, {500, 1595, 3191},
	{575, 1501, 3370}, {575, 1511, 3224},},
	[6519] = {{499, 1570, 3092}, {499, 1627, 3249},
	{498, 1877, 3203}, {498, 1637, 3189},
	{500, 1625, 3046}, {500, 1734, 3178},
	{575, 1490, 3261}, {575, 1597, 3344},},
	};

-- npc的说话内容{[npcid] = {[1] = "大家好，", [2] = "我来了",}, ...}
tbNpc.tbSkillMsg = {
	[6518] = {
			[1] = {nSkillId = 1528, nLevel = 1},
			[2] = {nSkillId = 1528, nLevel = 2},
			[3] = {nSkillId = 1528, nLevel = 3},
			[4] = {nSkillId = 1528, nLevel = 4},
			[5] = {nSkillId = 1528, nLevel = 5},
			[6] = {nSkillId = 1528, nLevel = 6},
			[7] = {nSkillId = 1528, nLevel = 7},
			[8] = {nSkillId = 1528, nLevel = 8},
			[9] = {nSkillId = 1528, nLevel = 9},
			[10] = {nSkillId = 1528, nLevel = 10},
			},
	[6520] = {
			[1] = {nSkillId = 1528, nLevel = 11},
			[2] = {nSkillId = 1528, nLevel = 12},
			[3] = {nSkillId = 1528, nLevel = 13},
			[4] = {nSkillId = 1528, nLevel = 14},
			[5] = {nSkillId = 1561, nLevel = 1},
			},
	[6519] = {
			[1] = {nSkillId = 1558, nLevel = 1},
			},
	};

--===============================================================

function tbNpc:StartCastSkill()
	for nNpcTemplateId, tbPosInfo in pairs(self.tbNpcPos) do
		for _, tbPos in pairs(tbPosInfo) do
			local pNpc = KNpc.Add2(nNpcTemplateId, 1, -1, unpack(tbPos));
			if (pNpc and self.tbSkillMsg[nNpcTemplateId]) then
				local tbMsg = self.tbSkillMsg[nNpcTemplateId];
				local tbNpcData = pNpc.GetTempTable("Marry") or {};
				tbNpcData.nJiaoyuSkillInfoIndex = 1;
				if (#tbMsg >= 1) then
					Timer:Register(self.CASTSKILL_TIME * Env.GAME_FPS, self.CastSkill, self, pNpc.dwId, tbMsg);
				end
			end
		end
	end
end

function tbNpc:CastSkill(dwId, tbSkillMsg)
	local pNpc = KNpc.GetById(dwId);
	if (not pNpc) then
		return 0;
	end
	local tbNpcData = pNpc.GetTempTable("Marry") or {};
	local nSkillInfoIndex = tbNpcData.nJiaoyuSkillInfoIndex or 1;
	if (nSkillInfoIndex >= #tbSkillMsg) then
		nSkillInfoIndex = 1;
	end
	
	pNpc.CastSkill(tbSkillMsg[nSkillInfoIndex].nSkillId, tbSkillMsg[nSkillInfoIndex].nLevel,
		-1, pNpc.nIndex);

	tbNpcData.nJiaoyuSkillInfoIndex = nSkillInfoIndex + 1;
end

ServerEvent:RegisterServerStartFunc(Marry.tbJiaoyuHuatong.StartCastSkill, Marry.tbJiaoyuHuatong);
