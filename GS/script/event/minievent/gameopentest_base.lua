--公测活动
--孙多良
--2008.09.22

Require("\\script\\event\\minievent\\gameopentest_time.lua")

local tbGameOpenTest = SpecialEvent.GameOpenTest;

tbGameOpenTest.MAP_LEVEL =
{
	[46] = 1,
	[47] = 1,
	[48] = 1,
	[49] = 1,
	[50] = 1,
	[51] = 1,
	[52] = 1,
	[53] = 1,
	[54] = 1,
	[55] = 1,
	[56] = 1,
	[57] = 1,
	[58] = 1,
	[59] = 1,
	[60] = 1,
	[61] = 1,
	[62] = 1,
	[63] = 1,
	[64] = 1,
	[65] = 1,
	[66] = 1,
	[67] = 1,
	[68] = 1,
	[69] = 1,
	[70] = 1,
	[71] = 1,
	[72] = 1,
	[73] = 1,
	[74] = 1,
	[75] = 1,
	[86] = 2,
	[87] = 2,
	[88] = 2,
	[89] = 2,
	[90] = 2,
	[91] = 2,
	[92] = 2,
	[93] = 2,
	[94] = 2,
	[95] = 2,
	[96] = 2,
	[97] = 2,
	[98] = 2,
	[99] = 2,
	[100] = 2,
	[101] = 2,
	[102] = 2,
	[103] = 2,
	[104] = 2,
	[105] = 2,
	[106] = 2,
	[107] = 3,
	[108] = 3,
	[109] = 3,
	[110] = 3,
	[111] = 3,
	[112] = 3,
	[113] = 3,
	[114] = 3,
	[115] = 3,
	[116] = 3,
	[117] = 3,
	[118] = 3,
	[119] = 3,
	[120] = 3,
	[121] = 3,
	[122] = 3,
	[123] = 3,
	[124] = 3,
	[125] = 3,
	[126] = 3,
	[127] = 3,
	[128] = 3,
	[129] = 3,
}


tbGameOpenTest.RABBIT_ID = {[1] = 1487,[2] = 1494,[3] = 1495};--财宝兔
tbGameOpenTest.SMALL_RABBIT_ID = {[1487] = 1488, [1494] = 1496, [1495] = 1497};			--小兔子
tbGameOpenTest.TIME_PER = 5 * Env.GAME_FPS;		--每5秒招3只小兔子
tbGameOpenTest.RABBIT_LIVE_TIME = 30 * Env.GAME_FPS;			--财宝兔生存时间
tbGameOpenTest.SMALL_RABBIT_LIVE_TIME = 30 * Env.GAME_FPS;		--小兔子生存时间
tbGameOpenTest.TASK_GROUP_ID = 2038;				--任务Group组
tbGameOpenTest.TASK_DAY 	 = 2;				--记录天
tbGameOpenTest.TASK_COUNT 	 = 3;				--使用次数，每天最多使用5次
tbGameOpenTest.PATH_DROP_YANHUA = "\\\setting\\event\\manager\\2008_event\\gameopentest\\yanhua_dropitem.txt";			--掉落表

function tbGameOpenTest:CallRabbit(nMapId, nX, nY, nLevel)
	print(nLevel, -1, nMapId, nX, nY)
	local nRabbit = self.RABBIT_ID[1];
	if self.MAP_LEVEL[nMapId] then
		nRabbit = self.RABBIT_ID[self.MAP_LEVEL[nMapId]];
	end
	local pNpc	= KNpc.Add2(nRabbit, nLevel, -1, nMapId, nX, nY);
	if pNpc then
		local tbTemp = pNpc.GetTempTable("Npc");
		tbTemp.nCallCount = 0;
		pNpc.SetLiveTime(self.RABBIT_LIVE_TIME);
		Timer:Register(self.TIME_PER, self.CallSmallRabbit, self, pNpc.dwId);
	end
end

function tbGameOpenTest:CallSmallRabbit(nNpcId)
	local pNpc = KNpc.GetById(nNpcId);
	if not pNpc then
		return 0
	end
	local tbTemp = pNpc.GetTempTable("Npc");
	if not tbTemp.nCallCount or tbTemp.nCallCount >= 7 then
		return 0;
	end
	tbTemp.nCallCount = tbTemp.nCallCount + 1;
	local nMapId, nX, nY = pNpc.GetWorldPos();
	for i=1, 3 do
		local pSmallNpc	= KNpc.Add2(self.SMALL_RABBIT_ID[pNpc.nTemplateId], pNpc.nLevel, -1, nMapId, nX, nY);
		pSmallNpc.SetLiveTime(self.SMALL_RABBIT_LIVE_TIME);
	end
	return self.TIME_PER;
end

